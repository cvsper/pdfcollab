{% extends "base.html" %}

{% block title %}User 1 - Upload & Edit PDF - PDF Collaborator{% endblock %}

{% block content %}
<!-- Enhanced User 1 Interface with Real PDF Field Editing -->
<div class="space-y-8">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-900">User 1 - Upload & Edit PDF Fields</h2>
        <a href="{{ url_for('dashboard') }}" 
           class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            Cancel
        </a>
    </div>

    <form method="POST" id="user1Form">
        <!-- PDF Document Info Section -->
        <div class="bg-white shadow sm:rounded-lg overflow-hidden">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900">PDF Document: homworks.pdf</h3>
                <div class="mt-2 max-w-xl text-sm text-gray-500">
                    <p>Using the local PDF document. We'll extract the form fields automatically and let you assign which fields User 2 should complete.</p>
                </div>
                <div class="mt-5">
                    <div class="flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-md">
                        <div class="flex items-center">
                            <svg class="h-8 w-8 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                            </svg>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">homworks.pdf</p>
                                <p class="text-sm text-gray-500">Local PDF file ready for processing</p>
                            </div>
                        </div>
                        <button type="button" onclick="processLocalPDF()" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                            </svg>
                            Process PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PDF Field Editor - Shows after processing -->
        <div id="pdf-editor" class="bg-white shadow sm:rounded-lg overflow-hidden">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Edit PDF Fields & Assign to Users</h3>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-blue-100 border-2 border-blue-500 rounded mr-2"></div>
                            <span class="text-sm text-gray-600">Your fields</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-orange-100 border-2 border-orange-500 rounded mr-2"></div>
                            <span class="text-sm text-gray-600">User 2 fields</span>
                        </div>
                    </div>
                </div>

                <!-- Field List and Assignment -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h4 class="font-medium text-gray-900">PDF Form Sections</h4>
                        <div class="text-sm text-gray-500">
                            <span id="fields-count"></span>
                        </div>
                    </div>
                    
                    <!-- Progress Indicator -->
                    <div id="section-progress" class="hidden mb-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">Progress</span>
                            <span class="text-sm text-gray-500">
                                <span id="current-section">1</span> of <span id="total-sections">5</span>
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 20%"></div>
                        </div>
                        <div class="flex justify-between mt-2 text-xs text-gray-500">
                            <span>Property Info</span>
                            <span>Applicant Info</span>
                            <span>Qualification</span>
                            <span>Authorization</span>
                            <span>Affidavit</span>
                        </div>
                    </div>
                    
                    <div id="loading-fields" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        <p class="mt-2 text-gray-500">Analyzing PDF fields...</p>
                    </div>
                    
                    <!-- Slide Container -->
                    <div id="pdf-fields-list" class="hidden">
                        <div id="section-slides" class="relative overflow-hidden">
                            <!-- Sections will be populated here as slides -->
                        </div>
                        
                        <!-- Navigation Controls -->
                        <div id="slide-navigation" class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
                            <button id="prev-section" 
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                    onclick="previousSection()" disabled>
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                Previous Section
                            </button>
                            
                            <div class="text-center">
                                <h5 id="current-section-title" class="text-lg font-medium text-gray-900"></h5>
                                <p id="current-section-description" class="text-sm text-gray-500"></p>
                            </div>
                            
                            <button id="next-section" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700"
                                    onclick="nextSection()">
                                Next Section
                                <svg class="w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div id="no-fields" class="text-center py-8 hidden">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <p class="text-gray-500">No editable fields detected in this PDF</p>
                        <p class="text-sm text-gray-400 mt-1">You can still proceed with the workflow</p>
                    </div>
                </div>

                <!-- User Information Section -->
                <div class="mt-8 border-t pt-6">
                    <h4 class="text-md font-medium text-gray-900 mb-4">Your Information</h4>
                    <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-2">
                        <div>
                            <label for="user1_name" class="block text-sm font-medium text-gray-700">Full Name *</label>
                            <input type="text" name="user1_name" id="user1_name" required
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="user1_email" class="block text-sm font-medium text-gray-700">Email Address *</label>
                            <input type="email" name="user1_email" id="user1_email" required
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-8 flex justify-end space-x-3">
                    <a href="{{ url_for('dashboard') }}" 
                       class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </a>
                    <button type="submit" id="submit-btn"
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                        </svg>
                        Submit to User 2
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
let currentDocumentId = null;
let pdfFields = [];

// Test function for debugging
function testAPI() {
    console.log('üß™ Testing API connectivity...');
    fetch('/api/extract-fields', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        console.log('API test result:', data);
    })
    .catch(error => {
        console.error('API test failed:', error);
    });
}

// Local PDF processing
function processLocalPDF() {
    console.log('üîç Processing local PDF file...');
    
    // Show PDF editor section
    document.getElementById('pdf-editor').classList.remove('hidden');
    
    // Start PDF processing immediately
    console.log('‚è≥ Starting PDF processing...');
    loadPDFFields();
    
    // Scroll to editor
    document.getElementById('pdf-editor').scrollIntoView({ behavior: 'smooth' });
}

function loadPDFFields() {
    console.log('üîÑ Starting PDF field extraction for local file...');
    
    // Show PDF editor section
    document.getElementById('pdf-editor').classList.remove('hidden');
    
    // Extract PDF fields first, then preview
    console.log('üöÄ Calling /api/extract-fields-local...');
    fetch('/api/extract-fields-local', {
        method: 'POST'
    })
    .then(response => {
        console.log('üì° Extract fields response status:', response.status);
        return response.json();
    })
    .then(fieldsData => {
        console.log('‚úÖ Fields API response:', fieldsData);
        
        // Hide loading
        document.getElementById('loading-fields').classList.add('hidden');
        
        // Handle PDF fields
        if (fieldsData.error) {
            console.error('‚ùå PDF fields extraction error:', fieldsData.error);
            showErrorMessage('Error extracting PDF fields: ' + fieldsData.error);
            document.getElementById('no-fields').classList.remove('hidden');
            return;
        }
        
        if (fieldsData.fields && fieldsData.fields.length > 0) {
            pdfFields = fieldsData.fields;
            console.log('üìã Loaded PDF fields:', pdfFields.length);
            pdfFields.forEach((field, index) => {
                console.log(`   ${index + 1}. ${field.name} (${field.id}) ‚Üí ${field.assigned_to} [${field.value || 'empty'}]`);
            });
            
            // Update field count display
            document.getElementById('fields-count').textContent = `${fieldsData.fields.length} fields organized in 5 sections`;
            
            document.getElementById('pdf-fields-list').classList.remove('hidden');
            renderPDFFields();
            showNotification(`Successfully detected ${fieldsData.fields.length} fields from your PDF!`, 'success');
        } else {
            console.warn('‚ö†Ô∏è No fields found in PDF');
            // No fields found
            document.getElementById('no-fields').classList.remove('hidden');
            showNotification('No form fields detected in this PDF. You can add custom fields manually.', 'info');
        }
    })
    .catch(error => {
        console.error('‚ùå Error processing PDF:', error);
        document.getElementById('loading-fields').classList.add('hidden');
        document.getElementById('no-fields').classList.remove('hidden');
        showErrorMessage('Failed to analyze PDF. You can add custom fields manually.');
    });
}

// PDF preview functionality removed - focusing on field organization

function showErrorMessage(message) {
    showNotification(message, 'error');
}

// Global variables for slide navigation
let currentSectionIndex = 0;
let formSections = [];

function renderPDFFields() {
    // Define field sections based on actual PDF structure
    formSections = [
        {
            title: "Section 1: Property Information (1-4 Units)",
            description: "Property details and basic information",
            fieldNames: [
                "Property Address", "Apartment Number", "Num Of Apt1"
            ]
        },
        {
            title: "Section 2: Applicant and Energy Information", 
            description: "Personal details, heating fuel type, and utility information",
            fieldNames: [
                "First Name", "Last Name", "City", "State", "ZIP Code", "Phone Number", "Email Address",
                "Electric Heat (Radio Button)", "Gas Heat (Radio Button)", "Oil Heat (Radio Button)", 
                "Propane Heat (Radio Button)", "Property Owner (Radio Button)", "Renter (Radio Button)",
                "Single Family Home (Checkbox)", "Apartment (Checkbox)", "Condominium (Checkbox)",
                "Electric Eversource2 (Radio Button)", "Electric Ui2 (Radio Button)", 
                "Gas Util Cng2 (Radio Button)", "Gas Util Eversource2 (Radio Button)", "Gas Util Scg2 (Radio Button)",
                "Elect Acct Applicant2 (Radio Button)", "Elect Acct Other2 (Radio Button)", 
                "Gas Acct Applicant2 (Radio Button)", "Gas Acct Other2 (Radio Button)", "Elect Acct Other Acct2 (Radio Button)",
                "Radio Group 13Hbmf", "Elect Acct Other Name2", "Gas Acct Other Name2", "Elec Acct Num2", "Gas Acct Num2"
            ]
        },
        {
            title: "Section 3: Applicant Qualification Information",
            description: "Income eligibility and qualification options", 
            fieldNames: [
                "People In Household4", "People In Household Overage4", "Annual Income4",
                "Elec Discount4 (Checkbox)", "Low Income Program (Checkbox)",
                "Matching Payment Eversource4 (Checkbox)", "Bill Forgiveness Program (Checkbox)", 
                "Matching Pay United4 (Checkbox)",
                "EBT (Food Stamps) (Checkbox)", "Energy Award Letter4 (Checkbox)", 
                "Section Eight4 (Checkbox)", "Multifam4 (Checkbox)"
            ]
        },
        {
            title: "Section 4: Authorization",
            description: "Applicant and property owner signatures",
            fieldNames: [
                "Applicant Signature", "Date", "Landlord Name3", "Address3", 
                "City", "Text 55Cits", "Text 56Qpfj", "Property Owner Signature", 
                "Phone Number", "Date", "Email Address"
            ]
        },
        {
            title: "Section 5: Zero Income Affidavit",
            description: "For household members over 18 with no income (if applicable)",
            fieldNames: [
                // Note: These fields may need to be added manually if not detected in the PDF
                "Account Holder Name (Affidavit)",
                "Household Member Names (No Income)",
                "Affidavit Signature", 
                "Printed Name (Affidavit)",
                "Date (Affidavit)",
                "Telephone (Affidavit)"
            ]
        }
    ];
    
    // Build sections with fields
    formSections.forEach((section, sectionIndex) => {
        // Filter and add fields for this section
        const sectionFields = pdfFields.filter(field => 
            section.fieldNames.includes(field.name)
        );
        
        // Special handling for Section 5 - create manual fields if not detected
        if (sectionIndex === 4 && sectionFields.length === 0) {
            // Create manual fields for Zero Income Affidavit - assigned to User 2
            const affidavitFields = [
                { name: "Account Holder Name (Affidavit)", type: "text", assigned_to: "user2" },
                { name: "Household Member Names (No Income)", type: "textarea", assigned_to: "user2" },
                { name: "Affidavit Signature", type: "signature", assigned_to: "user2" },
                { name: "Printed Name (Affidavit)", type: "text", assigned_to: "user2" },
                { name: "Date (Affidavit)", type: "date", assigned_to: "user2" },
                { name: "Telephone (Affidavit)", type: "tel", assigned_to: "user2" }
            ];
            
            // Define improved positions for Section 5 fields
            const improvedPositions = [
                {x: 145, y: 135, width: 250, height: 25},   // Account Holder Name - final position
                {x: 35, y: 255, width: 450, height: 80},   // Household Members - final position (larger)
                {x: 40, y: 480, width: 200, height: 30},   // Signature - final position
                {x: 305, y: 480, width: 230, height: 25},  // Printed Name - final position
                {x: 40, y: 525, width: 150, height: 25},   // Date - final position
                {x: 305, y: 525, width: 150, height: 25}   // Telephone - final position
            ];
            
            affidavitFields.forEach((fieldData, index) => {
                const position = improvedPositions[index] || {x: 80, y: 400 + index * 40, width: 200, height: 25};
                
                const field = {
                    id: `affidavit_field_${index}`,
                    name: fieldData.name,
                    pdf_field_name: fieldData.name.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase(),
                    type: fieldData.type,
                    value: '',
                    assigned_to: fieldData.assigned_to,
                    source: 'manual_affidavit',
                    page: 4,  // Page 5 (0-indexed) - Section 5 belongs on page 5
                    position: position
                };
                pdfFields.push(field); // Add to global fields array
                sectionFields.push(field);
            });
        }
        
        // Store fields in section object
        section.fields = sectionFields;
    });
    
    // Add any remaining fields that don't fit into the defined sections
    const categorizedFieldNames = formSections.flatMap(s => s.fieldNames);
    const uncategorizedFields = pdfFields.filter(field => 
        !categorizedFieldNames.includes(field.name)
    );
    
    if (uncategorizedFields.length > 0) {
        formSections.push({
            title: "Other Fields",
            description: "Additional fields detected in the PDF",
            fieldNames: uncategorizedFields.map(f => f.name),
            fields: uncategorizedFields
        });
    }
    
    // Show progress indicator and initialize slides
    document.getElementById('section-progress').classList.remove('hidden');
    document.getElementById('total-sections').textContent = formSections.length;
    
    // Initialize with first section
    currentSectionIndex = 0;
    renderCurrentSection();
    updateNavigationState();
}

function createFieldElement(field) {
    const div = document.createElement('div');
    div.className = `p-4 border rounded-lg ${field.assigned_to === 'user1' ? 'border-blue-300 bg-blue-50' : 'border-orange-300 bg-orange-50'}`;
    
    div.innerHTML = `
        <div class="flex justify-between items-start">
            <div class="flex-1">
                <h5 class="font-medium text-gray-900">${field.name}</h5>
                <p class="text-sm text-gray-600 capitalize">${field.type} field</p>
                ${field.assigned_to === 'user1' ? 
                    (field.type === 'radio' ? 
                        `<div class="mt-2 space-y-2">
                            <label class="inline-flex items-center">
                                <input type="radio" 
                                       name="radio_${field.id}" 
                                       value="yes"
                                       class="form-radio text-blue-600 focus:ring-blue-500"
                                       ${field.value === 'yes' || field.value === 'true' ? 'checked' : ''}
                                       onchange="updateFieldValue('${field.id}', 'yes')">
                                <span class="ml-2 text-sm text-gray-700">Yes</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" 
                                       name="radio_${field.id}" 
                                       value="no"
                                       class="form-radio text-blue-600 focus:ring-blue-500"
                                       ${field.value === 'no' || field.value === 'false' || field.value === 'Off' || !field.value ? 'checked' : ''}
                                       onchange="updateFieldValue('${field.id}', 'no')">
                                <span class="ml-2 text-sm text-gray-700">No</span>
                            </label>
                        </div>` 
                    : field.type === 'checkbox' ? 
                        `<div class="mt-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" 
                                       class="form-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                       ${field.value === 'true' || field.value === true || field.value === 'yes' ? 'checked' : ''}
                                       onchange="updateFieldValue('${field.id}', this.checked ? 'true' : 'false')">
                                <span class="ml-2 text-sm text-gray-700">${field.name}</span>
                            </label>
                        </div>` 
                    : `<input type="${field.type === 'textarea' ? 'text' : field.type}" 
                             class="mt-2 block w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                             placeholder="Enter value..."
                             value="${field.value || ''}"
                             onchange="updateFieldValue('${field.id}', this.value)"
                             onkeyup="updateFieldValue('${field.id}', this.value)"
                             onblur="updateFieldValue('${field.id}', this.value)">`)
                : `
                    <p class="text-sm text-orange-600 mt-1">üìù Assigned to User 2</p>
                `}
            </div>
            <div class="ml-4">
                <select onchange="reassignField('${field.id}', this.value)" 
                        class="text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <option value="user1" ${field.assigned_to === 'user1' ? 'selected' : ''}>My Field</option>
                    <option value="user2" ${field.assigned_to === 'user2' ? 'selected' : ''}>User 2 Field</option>
                </select>
            </div>
        </div>
    `;
    
    return div;
}

function renderCurrentSection() {
    const container = document.getElementById('section-slides');
    container.innerHTML = '';
    
    if (formSections.length === 0) return;
    
    const currentSection = formSections[currentSectionIndex];
    
    // Create section slide
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'mb-6 border border-gray-200 rounded-lg overflow-hidden';
    
    const headerDiv = document.createElement('div');
    headerDiv.className = 'bg-gray-50 px-4 py-3 border-b border-gray-200';
    headerDiv.innerHTML = `
        <h4 class="text-md font-semibold text-gray-900">${currentSection.title}</h4>
        <p class="text-sm text-gray-600">${currentSection.description}</p>
    `;
    sectionDiv.appendChild(headerDiv);
    
    const fieldsContainer = document.createElement('div');
    fieldsContainer.className = 'p-4 space-y-3';
    
    // Special handling for Section 5 note
    if (currentSectionIndex === 4) {
        const noteDiv = document.createElement('div');
        noteDiv.className = 'mb-4 p-3 bg-orange-50 border border-orange-200 rounded-md';
        noteDiv.innerHTML = `
            <p class="text-sm text-orange-800">
                <strong>Note:</strong> This section will be completed by User 2. Complete only if you qualify with Option C and have household members over 18 with no income.
            </p>
        `;
        fieldsContainer.appendChild(noteDiv);
    }
    
    // Render fields for current section
    if (currentSection.fields && currentSection.fields.length > 0) {
        currentSection.fields.forEach(field => {
            const fieldElement = createFieldElement(field);
            fieldsContainer.appendChild(fieldElement);
        });
    } else {
        const noFieldsDiv = document.createElement('div');
        noFieldsDiv.className = 'text-center py-4 text-gray-500';
        noFieldsDiv.textContent = 'No fields detected for this section';
        fieldsContainer.appendChild(noFieldsDiv);
    }
    
    sectionDiv.appendChild(fieldsContainer);
    container.appendChild(sectionDiv);
    
    // Update section title and description in navigation
    document.getElementById('current-section-title').textContent = currentSection.title;
    document.getElementById('current-section-description').textContent = currentSection.description;
}

function previousSection() {
    if (currentSectionIndex > 0) {
        currentSectionIndex--;
        renderCurrentSection();
        updateNavigationState();
        updateProgress();
    }
}

function nextSection() {
    if (currentSectionIndex < formSections.length - 1) {
        currentSectionIndex++;
        renderCurrentSection();
        updateNavigationState();
        updateProgress();
    }
}

function updateNavigationState() {
    const prevButton = document.getElementById('prev-section');
    const nextButton = document.getElementById('next-section');
    
    // Update Previous button
    prevButton.disabled = currentSectionIndex === 0;
    
    // Update Next button
    if (currentSectionIndex === formSections.length - 1) {
        nextButton.innerHTML = `
            Complete Review
            <svg class="w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
        `;
        nextButton.onclick = () => {
            // Scroll to form submission section
            document.querySelector('.mt-8.border-t.pt-6').scrollIntoView({ behavior: 'smooth' });
            showNotification('All sections completed! Please review and submit.', 'success');
        };
    } else {
        nextButton.innerHTML = `
            Next Section
            <svg class="w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
        `;
        nextButton.onclick = nextSection;
    }
}

function updateProgress() {
    const progressPercentage = ((currentSectionIndex + 1) / formSections.length) * 100;
    document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
    document.getElementById('current-section').textContent = currentSectionIndex + 1;
}

function reassignField(fieldId, newAssignment) {
    // Update field assignment
    const field = pdfFields.find(f => f.id === fieldId);
    if (field) {
        field.assigned_to = newAssignment;
        renderCurrentSection(); // Re-render current section instead of all sections
        
        // Show feedback
        showNotification(`Field "${field.name}" assigned to ${newAssignment === 'user1' ? 'you' : 'User 2'}`, 'success');
    }
}

function updateFieldValue(fieldId, value) {
    console.log(`üîÑ updateFieldValue called: ${fieldId} = '${value}'`);
    const field = pdfFields.find(f => f.id === fieldId);
    if (field) {
        const oldValue = field.value;
        field.value = value;
        console.log(`   ‚úÖ Updated '${field.name}': '${oldValue}' ‚Üí '${value}'`);
    } else {
        console.log(`   ‚ùå Field not found: ${fieldId}`);
    }
}


function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg ${type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' : 'bg-red-100 border border-red-400 text-red-700'}`;
    notification.innerHTML = `
        <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                ${type === 'success' ? 
                    '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>' :
                    '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>'
                }
            </svg>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Form submission
document.getElementById('user1Form').addEventListener('submit', function(e) {
    // Debug: Log what we're submitting
    console.log('üöÄ User 1 form submission triggered');
    console.log('üìä pdfFields array:', pdfFields);
    console.log('üìã Fields count:', pdfFields.length);
    
    // Show field values being submitted
    const fieldsWithValues = pdfFields.filter(f => f.value);
    const fieldsWithoutValues = pdfFields.filter(f => !f.value);
    
    console.log('‚úÖ Fields WITH values:', fieldsWithValues.length);
    fieldsWithValues.forEach(field => {
        console.log(`   - ${field.name}: '${field.value}' ‚Üí ${field.assigned_to}`);
    });
    
    console.log('‚≠ï Fields WITHOUT values:', fieldsWithoutValues.length);
    fieldsWithoutValues.forEach(field => {
        console.log(`   - ${field.name}: (empty) ‚Üí ${field.assigned_to}`);
    });
    
    // Add field data to form
    const fieldData = document.createElement('input');
    fieldData.type = 'hidden';
    fieldData.name = 'pdf_fields';
    fieldData.value = JSON.stringify(pdfFields);
    this.appendChild(fieldData);
    
    console.log('üì§ Field data JSON length:', fieldData.value.length);
    console.log('üì§ Field data preview:', fieldData.value.substring(0, 200) + '...');
});
</script>
{% endblock %}